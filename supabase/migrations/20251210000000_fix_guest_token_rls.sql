-- ====================================================================
-- EventPay: ゲストトークンRLS修正マイグレーション
-- 目的: public.get_guest_token()を使用していて機能しないRLSポリシーを修正
-- 理由: SupabaseクライアントのHTTPヘッダーがPostgreSQLのcurrent_settingでアクセスできない
-- 解決策: 問題のあるポリシーを削除し、アプリケーション層で権限制御を実施
-- ====================================================================

BEGIN;

-- ====================================================================
-- 1. 機能しないゲストトークンベースのRLSポリシーを削除
-- ====================================================================

-- payments テーブルのゲストトークンベースポリシーを削除
-- 理由: public.get_guest_token() が HTTPヘッダーから値を取得できないため
DROP POLICY IF EXISTS "Guest token read payment details" ON public.payments;
DROP POLICY IF EXISTS "Guest token update payment details" ON public.payments;

-- ====================================================================
-- 2. ログと説明
-- ====================================================================

DO $$
BEGIN
  RAISE NOTICE 'ゲストトークンベースのRLSポリシーを削除しました。';
  RAISE NOTICE '理由: SupabaseクライアントのHTTPヘッダーがPostgreSQLでアクセス不可能';
  RAISE NOTICE '対策: アプリケーション層でサービスロールを使用した権限制御に移行';
  RAISE NOTICE '影響: payments テーブルへのゲストアクセスはアプリケーション層で制御';
END $$;

-- ====================================================================
-- 3. 代替案の説明（コメント）
-- ====================================================================

-- 注意: 以下のアプローチでRLSポリシーの問題を解決する
-- 
-- 1. ゲストが決済情報にアクセスする際は、アプリケーション層で以下を実施：
--    a) HTTPヘッダーからゲストトークンを取得
--    b) サービスロール（管理者権限）でRLSをバイパス
--    c) データベースから取得したguest_tokenとリクエストのトークンを照合
--    d) 照合成功時のみデータを返却
--
-- 2. この方式により以下を実現：
--    - セキュリティの確保（トークン照合）
--    - 機能の確実な動作（RLS問題の回避）
--    - 監査ログの記録（管理者権限使用の追跡）

COMMIT;
