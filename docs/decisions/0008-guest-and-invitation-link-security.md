# ADR-0008: ゲストリンク/招待リンクのセキュリティ設計

- Status: Accepted
- Date: 2025-12-21

## Context and Problem Statement

イベント管理システムにおいて、認証されていないユーザー（ゲスト）がイベントへの参加登録を行い、その後も自身の参加情報や決済情報にアクセスできる仕組みが必要。また、主催者がイベントへの参加を促すための招待リンクを共有できる必要がある。

以下の課題を解決する必要がある：

1. **認証不要のアクセス管理**: パスワードレスで参加者が自身の情報にアクセスできる仕組み
2. **データ漏洩の防止**: 他の参加者の個人情報（PII）への不正アクセスを防ぐ
3. **権限の適切な分離**: 招待リンク（イベント情報のみ）とゲストリンク（個人情報）の明確な権限分離
4. **時間ベースの権限制御**: イベント開始時刻や締切に応じた変更権限の管理
5. **セキュリティ監査**: すべてのアクセスを追跡可能にする

## Decision Drivers

- **セキュリティ**: 個人情報の保護とデータアクセスの最小権限原則
- **ユーザビリティ**: パスワード管理不要のシンプルな参加者体験
- **スケーラビリティ**: データベースレベルでの効率的なアクセス制御
- **監査可能性**: すべてのアクセスとセキュリティイベントの追跡
- **保守性**: 明確な権限モデルと拡張可能なアーキテクチャ
- **レースコンディション対策**: 定員管理やトークン重複の防止

## Considered Options

### Option A: セッションベースの認証システム
- 一時的なセッションを作成し、サーバー側でセッション情報を管理
- 従来型のセッションストアを使用

### Option B: JWTベースの認証トークン
- 署名付きJWTトークンを発行し、クレームとしてゲスト情報を埋め込む
- ステートレスな認証

### Option C: RLSポリシーベースの暗号学的トークン管理（採用）
- 暗号学的に安全なランダムトークンを生成
- データベースのRow Level Security（RLS）ポリシーでアクセス制御
- HTTPヘッダー経由でトークンを送信
- SECURITY DEFINER関数による権限昇格

## Decision Outcome

**Option C: RLSポリシーベースの暗号学的トークン管理**を採用。

### 採用理由

1. **データベースレベルのセキュリティ**: RLSポリシーにより、アプリケーション層のバグがあってもデータ漏洩を防止できる

2. **最小権限の原則**: ゲストトークンは自身の参加情報のみ、招待トークンはイベント情報のみにアクセス

3. **暗号学的安全性**: 24バイト（192ビット）のランダムデータをURL-safeなBase64でエンコード、推測困難なトークン

4. **トークン形式の明確化**: プレフィックス（`gst_`、`inv_`）により用途を明示

5. **包括的なエラーハンドリング**: 詳細なエラーコードとユーザーメッセージの分離

6. **セキュリティ監査**: すべてのアクセスを構造化ログとして記録

7. **時間ベースの権限管理**: イベント開始時刻、登録締切、キャンセル状態に基づく自動的な権限制御

8. **レースコンディション対策**: 排他ロック（FOR UPDATE）を使用した定員管理と重複防止

## Consequences

### Positive

1. **高いセキュリティレベル**: データベース層での多層防御により、アプリケーションバグによるデータ漏洩リスクを最小化
2. **シンプルなUX**: パスワード不要で参加者がリンクのみでアクセス可能
3. **明確な権限モデル**: RLSポリシーによりコードレビューとセキュリティ監査が容易
4. **スケーラビリティ**: ステートレスな設計により水平スケーリングが容易
5. **監査証跡**: すべてのアクセスが追跡可能で、セキュリティインシデントの調査が可能
6. **トークンの自己説明性**: プレフィックスにより用途が明確で、デバッグやログ解析が容易
7. **柔軟な権限管理**: 時間経過に伴う自動的な権限変更が実装可能

### Negative

1. **トークン管理の複雑さ**: トークンの紛失時のリカバリーフローが必要
2. **URLの長さ**: 36文字のトークンがURLに含まれるため、URLが長くなる
3. **データベース負荷**: RLSポリシーの評価によるわずかなオーバーヘッド

## Pros and Cons of the Options

### Option A: セッションベースの認証システム

**Pros:**
- 実装パターンが確立されている
- セッション管理ツールが豊富

**Cons:**
- セッションストアの管理が必要（Redis等）
- 水平スケーリング時の複雑さ
- セッションハイジャックのリスク
- URLでのシェアが困難

### Option B: JWTベースの認証トークン

**Pros:**
- ステートレスな設計
- トークンに情報を埋め込める

**Cons:**
- トークンの取り消しが困難
- トークンサイズが大きくなる可能性
- データベースレベルでのアクセス制御が不十分
- クレームの改ざん対策が必要

### Option C: RLSポリシーベースの暗号学的トークン管理（採用）

**Pros:**
- データベース層での強固なセキュリティ
- シンプルで推測困難なトークン
- RLSポリシーによる明確な権限モデル
- 包括的な監査ログ
- トークンの無効化が容易
- レースコンディション対策が組み込み可能

**Cons:**
- RLSポリシーの学習コスト
- データベース層での若干のオーバーヘッド
- トークン紛失時のリカバリーフロー実装が必要

## Links

- Supabase RLS Documentation: https://supabase.com/docs/guides/auth/row-level-security
- OWASP Authentication Cheat Sheet: https://cheatsheetseries.owasp.org/cheatsheets/Authentication_Cheat_Sheet.html
