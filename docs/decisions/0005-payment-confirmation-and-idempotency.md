# ADR-0005: 入金確定点（Webhook）・冪等性保証・再処理方針

- Status: Accepted
- Date: 2025-12-21

## Context and Problem Statement

Stripe決済のWebhook処理では、同一イベントが複数回配信され得るため、重複処理や取りこぼしを防ぐ設計が必要である。
また、Webhookエンドポイントはタイムアウト等を避けるため、可能な限り速く応答し、重い処理を切り離す方針が望ましい。

これらを明確化する。

- 入金（支払い成功）を「どのイベントで」「どの状態をもって」確定させるか
- 重複配信・再送・遅延に耐える冪等性をどう担保するか
- 一時障害時の再処理（自動リトライ/手動復旧）の方針をどうするか

## Decision Drivers

- データ整合性（重複処理・取りこぼし・状態の巻き戻りを防ぐ）
- 信頼性（障害時に自動復旧でき、最終的に整合した状態へ収束する）
- 運用性（調査可能性、再実行可能性、監査性）
- セキュリティ（Webhookの正当性検証、リプレイ/濫用への耐性）
- パフォーマンス（Webhookを速くACKし、ピークに耐える）

## Considered Options

### Option A: Webhook同期処理 + DB制約で冪等性
- Webhook受信リクエスト内でDB更新と通知まで完結する
- DBのUNIQUE制約等で重複を抑止する

### Option B: Webhookを受領・検証して即ACKし、処理は非同期化（採用）
- Webhook受信では「検証」と「キュー投入」までに限定する
- 実処理は非同期Workerで行い、リトライと冪等性を複数層で担保する

### Option C: イベントソーシング / CQRS
- すべてのイベントを不変ログ化し、読み取りモデルを構築する

## Decision Outcome

**Option B（Webhook受領は最小処理 + 非同期Workerで確定）を採用**。

### 入金確定点（イベント別の役割）

- `checkout.session.completed`
  - 「セッション（Checkout）と内部データの突合に必要な識別子を保存する」
  - ここでは入金確定（paid化）を行わない（あくまで補助情報）

- `payment_intent.succeeded`
  - 「支払い成功」を一次確定として扱い、内部の支払いステータスを `paid` に昇格させる
  - この処理は冪等であること（同じイベントが再到達しても同じ結果）を必須条件とする

- `charge.succeeded`
  - 手数料や残高取引など、後続で確定する詳細情報を保存する
  - 必要に応じて、通知や監査ログなど「副作用」をここで最終確定として扱う

> 目的は「UI上の入金状態（paid）」と「Stripe上の成功」を確実に収束させることであり、イベントの重複・順不同・遅延を前提に設計する。

## Idempotency Strategy（多層冪等性）

冪等性は“1箇所に賭けない”方針とし、以下の層で防御する。

1. **Queueレベルの重複排除**
   - Stripeの `event.id` を基準に、同一イベントの多重実行を抑止する（可能な範囲で）

2. **ドメイン状態の単調増加（降格禁止）**
   - 支払い状態は「未払い → 支払い済み」のように単調増加とし、遅延イベントで状態が巻き戻らないようにする
   - “昇格可能か”を判定するガードを必須にする

3. **副作用のdedupe**
   - 監査ログ/通知などの副作用には dedupe key を導入し、同一内容の多重送信・多重記録を防ぐ

4. **Stripe API呼び出し時の冪等性（必要に応じて）**
   - Checkout Session作成等でStripeに対して「同一リクエスト再送」を行う可能性がある箇所は、StripeのIdempotency Keyを利用する

## Retry / Reprocessing Policy（再処理方針）

### 自動リトライ（非終端エラー）
- DB接続断、タイムアウト、一時的な外部依存の失敗などは **再実行で成功する可能性** があるため自動リトライ対象とする
- リトライはキュー基盤側（例: QStash等）の仕組みを利用し、Workerは「失敗時は例外を返す」ことでリトライに委ねる

### 終端エラー（リトライしない）
- 署名検証失敗など「正当なイベントではない」
- データ不整合など「再実行しても成功しない」ことが明らかなケース
- これらは終端扱いとして、監査ログとアラート（必要なら）に回す

### 手動復旧
- リトライ上限到達や終端エラーは、運用者がログを見て原因を解消した上で再投入/再実行できる導線を残す
- “再処理が必要なイベント”を特定できる記録（イベントID、対象支払いID、失敗理由）を残す

## Security

- Stripe Webhookの署名検証を必須とする
- （本番のみ）必要に応じて追加のアクセス制御（IP制限等）を行う
- キュー経由の場合は、キュー側の署名/認証も検証し、Webhook→Workerの経路を保護する

## Consequences

### Positive
- Webhookは検証→即ACK→非同期化により、タイムアウトやピーク負荷に強くなる。
- 重複配信・順不同・遅延に対して、状態遷移ガードとdedupeで整合性を保ちやすい。
- 障害時に「自動リトライ」と「手動復旧」を分離でき、運用が整理される

### Negative / Trade-offs
- 非同期化により、UI反映にわずかな遅延が入り得る
- キュー基盤に依存し、デバッグ時に追うべきログが増える
- 冪等性が多層化し、設計の理解コストが上がる（代わりに安全性が上がる）
